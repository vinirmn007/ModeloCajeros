<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulaci贸n de Cajas (Python + JS)</title>
    
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">


</head>
<body>
    <h1>Simulaci贸n de Cajas de Supermercado</h1>
    <div class="controles">
        <div class="grupo-inputs">
            
            <div class="control-caja">
                <label for="n-caja1">Caja 1</label>
                <input type="number" id="n-caja1" min="0" placeholder="Clientes">
                <select id="tipo-caja1">
                    <option value="normal" selected>Normal</option>
                    <option value="principiante">Principiante</option>
                </select>
            </div>
            
            <div class="control-caja">
                <label for="n-caja2">Caja 2</label>
                <input type="number" id="n-caja2" min="0" placeholder="Clientes">
                <select id="tipo-caja2">
                    <option value="normal" selected>Normal</option>
                    <option value="principiante">Principiante</option>
                </select>
            </div>
            
            <div class="control-caja">
                <label for="n-caja3">Caja 3</label>
                <input type="number" id="n-caja3" min="0" placeholder="Clientes">
                <select id="tipo-caja3">
                    <option value="normal" selected>Normal</option>
                    <option value="principiante">Principiante</option>
                </select>
            </div>
            
            <div class="control-caja">
                <label for="n-caja4">Caja 4</label>
                <input type="number" id="n-caja4" min="0" placeholder="Clientes">
                <select id="tipo-caja4">
                    <option value="normal" selected>Normal</option>
                    <option value="principiante">Principiante</option>
                </select>
            </div>
            
            <div class="control-caja">
                <label for="n-caja-express" style="color: #007bff;">Caja Express</label>
                <input type="number" id="n-caja-express" min="0" placeholder="Clientes">
                <select id="tipo-caja-express">
                    <option value="normal" selected>Normal</option>
                    <option value="principiante">Principiante</option>
                </select>
            </div>

        </div>
       
        <button id="btn-simular">Iniciar Simulaci贸n</button>
    </div>

    <div id="resultados" style="display: none;"></div>

    <div class="supermercado">
        <div class="caja" id="caja1">
            <h3>Caja 1</h3>
            <div class="fila" id="fila-caja1"></div>
        </div>
        <div class="caja" id="caja2">
            <h3>Caja 2</h3>
            <div class="fila" id="fila-caja2"></div>
        </div>
        <div class="caja" id="caja3">
            <h3>Caja 3</h3>
            <div class="fila" id="fila-caja3"></div>
        </div>
        <div class="caja" id="caja4">
            <h3>Caja 4</h3>
            <div class="fila" id="fila-caja4"></div>
        </div>
        <div class="caja express" id="caja-express">
            <h3>Caja Express</h3>
            <div class="fila" id="fila-caja-express"></div>
        </div>
    </div>

    <script>
        
        
        const VELOCIDAD_SIMULACION_MS = 20;
        const TIEMPO_ANIMACION_MS = 300; // 150ms = 0.15s

        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));


        
        async function simularCaja(idCaja, plan, esExpress = false) {
            const cajaElement = document.getElementById(idCaja);
            const filaElement = document.getElementById('fila-' + idCaja);
            
            filaElement.innerHTML = '';
            cajaElement.classList.add('activa'); 
            
             const tiemposDeEspera = plan.tiempos;
            const articulosClientes = plan.articulos;
            
            const clientesParaProcesar = [];

            
            for (let i = 0; i < tiemposDeEspera.length; i++) {
                const tiempoCliente = tiemposDeEspera[i];
                const articulosCliente = articulosClientes[i];
                
                const clienteDiv = document.createElement('div');
                clienteDiv.classList.add('cliente');
                if (esExpress) {
                    clienteDiv.classList.add('express');
                }
                
                clienteDiv.innerText = articulosCliente; 
                filaElement.appendChild(clienteDiv); 
                
                clientesParaProcesar.push({ 
                    div: clienteDiv, 
                    
                    tiempo: tiempoCliente
                });
            }
            
            await sleep(300);

            
            for (const cliente of clientesParaProcesar) {
                const tiempoEsperaEscalado = cliente.tiempo * VELOCIDAD_SIMULACION_MS;
                await sleep(tiempoEsperaEscalado); 
                cliente.div.classList.add('atendido');
                await sleep(TIEMPO_ANIMACION_MS); 
                cliente.div.remove();
            }

            cajaElement.classList.remove('activa');
        }

        async function iniciarSimulacion() {
            const boton = document.getElementById('btn-simular');
            const resultadosDiv = document.getElementById('resultados');

            boton.disabled = true;
            boton.innerText = 'Consultando Backend...';
            resultadosDiv.style.display = 'none';
            resultadosDiv.innerHTML = '';

            // --- LECTURA DE DATOS (MODIFICADO) ---
            const n1 = document.getElementById('n-caja1').value;
            const tipo1 = document.getElementById('tipo-caja1').value; 
            
            const n2 = document.getElementById('n-caja2').value;
            const tipo2 = document.getElementById('tipo-caja2').value; 
            
            const n3 = document.getElementById('n-caja3').value;
            const tipo3 = document.getElementById('tipo-caja3').value; 
            
            const n4 = document.getElementById('n-caja4').value;
            const tipo4 = document.getElementById('tipo-caja4').value;
            
            
            
            const n_exp = document.getElementById('n-caja-express').value;
            const tipo_exp = document.getElementById('tipo-caja-express').value; 

            let DelBackend;
            try {
            
                const url = `/simular?n1=${n1}&tipo1=${tipo1}` +
                            `&n2=${n2}&tipo2=${tipo2}` +
                            `&n3=${n3}&tipo3=${tipo3}` +
                            `&n4=${n4}&tipo4=${tipo4}` +
                            `&n_exp=${n_exp}&tipo_exp=${tipo_exp}`;
                            
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`Error del Servidor: ${response.statusText}`);
                }
                
                datosDelBackend = await response.json();
                

            } catch (error) {
                
                boton.disabled = false;
                boton.innerText = 'Error. 驴Iniciaste el backend?';
                resultadosDiv.innerHTML = `<h2>Error de Conexi贸n</h2><p>No se pudo conectar al servidor de Python.</p><p>Aseg煤rate de tener 'app.py' ejecut谩ndose.</p>`;
                resultadosDiv.style.display = 'block';
                console.error('Error al hacer fetch:', error);
                return;
            }
            
            boton.innerText = 'Simulando...';

            
            const plan = datosDelBackend.plan_simulacion;
            const totales = datosDelBackend.totales_backend; 

          
            const promesasDeSimulacionVisual = [
                simularCaja('caja1', plan.caja1, false),
                simularCaja('caja2', plan.caja2, false),
                simularCaja('caja3', plan.caja3, false),
                simularCaja('caja4', plan.caja4, false),

                simularCaja('caja-express', plan.caja_express, true)
            ];

            
            await Promise.all(promesasDeSimulacionVisual);

        
            const tiemposFiltrados = Object.entries(totales).filter(([key, value]) => value > 0);
            
            let mejorCaja = "N/A";
            let contenidoResultados = "<h2>Resultados Finales (Calculados por Python)</h2>"; // T铆tulo actualizado

            if (tiemposFiltrados.length > 0) {
                const [mejor] = tiemposFiltrados.reduce((mejor, actual) => {
                    return actual[1] < mejor[1] ? actual : mejor;
                });
                mejorCaja = mejor;

                for (const [nombre, tiempo] of Object.entries(totales)) {
                    if (tiempo > 0) {
                        const minutos = Math.floor(tiempo / 60);
                        const segundos = tiempo % 60;
                        contenidoResultados += `${nombre}: <strong>${tiempo}s</strong> (Aprox. ${minutos} min ${segundos}s)<br>`;
                    } else {
                        contenidoResultados += `${nombre}: <strong>0s</strong> (Sin clientes)<br>`;
                    }
                }
                contenidoResultados += `<hr><p class="ganador"> La mejor opci贸n fue: ${mejorCaja}</p>`;
            
            } else {
                contenidoResultados += "<p>No se simularon clientes.</p>";
            }

            resultadosDiv.innerHTML = contenidoResultados;
            resultadosDiv.style.display = 'block';
            boton.disabled = false;
            boton.innerText = 'Iniciar Simulaci贸n de Nuevo';
        }

        document.getElementById('btn-simular').addEventListener('click', iniciarSimulacion);

    </script>
</body>
</html>